#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook to prevent pushing code that fails Docker build

set -e

echo "ğŸ” Running pre-push checks..."

# Check if Docker is available and running
if ! command -v docker &> /dev/null; then
    echo "âš ï¸  Docker is not installed. Skipping Docker build check."
    exit 0
fi

# Check if Docker daemon is running
if ! docker info > /dev/null 2>&1; then
    echo "âš ï¸  Docker daemon is not running. Skipping Docker build check."
    echo "ğŸ’¡ Make sure Docker is running before pushing to ensure build works."
    exit 0
fi

# Check if we're pushing to main/master branch
protected_branches='^(main|master)$'
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

if [[ $current_branch =~ $protected_branches ]]; then
    echo "ğŸš¨ Pushing to protected branch: $current_branch"
    echo "ğŸ”¨ Testing Docker build..."
    
    # Test Docker build
    if docker build \
        --build-arg NEXT_PUBLIC_SITE_URL=https://neuralcosmology.com \
        --target builder \
        -t neurocosmology-test:pre-push \
        . > /tmp/docker-build.log 2>&1; then
        echo "âœ… Docker build test passed!"
        # Clean up test image
        docker rmi neurocosmology-test:pre-push 2>/dev/null || true
    else
        echo "âŒ Docker build failed!"
        echo ""
        echo "Build log:"
        tail -50 /tmp/docker-build.log
        echo ""
        echo "ğŸ’¡ Fix the Docker build errors before pushing."
        exit 1
    fi
else
    echo "â„¹ï¸  Not a protected branch, skipping Docker build check."
fi
